<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
<meta name="viewport" content="user-scalable=no, width=device-width"  />
<meta name="apple-mobile-web-app-capable" content="yes" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>  
<!--
    Include the maps javascript with sensor=true because this code is using a
    sensor (a GPS locator) to determine the user's location.
    See: http://code.google.com/apis/maps/documentation/javascript/basics.html#SpecifyingSensor
    -->
    <script type="text/javascript"
        src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>
  <title>vitrum/node_123 @ GitHub</title>

<link rel="stylesheet" media="all" href="css/style.css" />
</head>

<body>

<div id="status" name="status">Status Message</div>
  <div id="info" class="log"></div>
  <div class="menu">
    <button id="btnClen" class="btn btn_red btn_small" >Clearn</button>
    <button id="btnLoad" class="btn btn_small" >Load</button>
	<button id="btnWatch" class="btn btn_small" >Watch</button>
	<button id="btnWatchStop" class="btn btn_small" >Stop Watch</button>
    <button id="btnInit" class="btn btn_small" >Find my location</button>
  
  </div> 

<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.2&services=true"></script>
<script type="text/javascript">

// HTML5 Web SQL Database
	var db = openDatabase('node_123', '1.0', 'Test DB', 2 * 1024 * 1024);
	var msg;

/*geolocation  */
	
	var touchTime = 1 ;	
	var watchID;

	db.transaction(function (tx) {
	  tx.executeSql('SELECT * FROM LOGS ORDER BY id DESC', [], function (tx, results) {
		touchTime = results.rows.item(0).id + 1;
	 }, null);
	});
	
	
	var geolocationJson = new Object();
	var bm = new BMap.Map("container");
	var newgps_x , newgps_y;

	jQuery(window).ready(function(){  
		
		jQuery("#btnInit").click(listenForPositionUpdates); 
		jQuery("#btnClen").click(clearn_log); 
		jQuery("#btnSave").click(save_log); 
		jQuery("#btnLoad").click(load_log); 
		jQuery("#btnWatch").click(listenForPositionUpdates);
		jQuery("#btnWatchStop").click(watch_stop);
		
	});  

	function initiate_geolocation() {  
		navigator.geolocation.getCurrentPosition(handle_geolocation_query,errorCallback);  
		//navigator.geolocation.watchPosition(handle_geolocation_query,errorCallback);  
	}  
	
	function errorCallback(error) {
	  // Update a div element with error.message.
	  var text = "touchTime:" + touchTime + "<br/>error.message: "  + error.message + "<br/>" ;;
	  jQuery("#info").prepend(text); 
	  
	}
        
	function handle_geolocation_query(position){ 
		var tempTime = new Date(position.timestamp);
		 var text =  "touchTime:" + touchTime + "<br/>" + 
		   "Latitude: "  + position.coords.latitude  + "<br/>" +  
		   "Longitude: " + position.coords.longitude + "<br/>" + 
		   //"altitude: " + position.coords.altitude + "<br/>" +  
		   //"heading: " + position.coords.heading + "<br/>" +  
		   //"speed: " + position.coords.speed + "<br/>" +  
		   "Accuracy: "  + position.coords.accuracy  + "m<br/>" +  
		   "Time: " + tempTime + "<br/><br/>" ;
		   
		jQuery("#info").prepend(text); 
		geolocationJson = position.coords;
		touchTime = touchTime + 1 ;


		db.transaction(function (tx) {
		  tx.executeSql('CREATE TABLE IF NOT EXISTS LOGS (id unique, latitude, longitude ,accuracy ,timestamp )');
		  var tmpTxt = '"' + position.coords.latitude + '",' + 
						'"' + position.coords.longitude + '",'+ 
						'"' + position.coords.accuracy + '",'+ 
						'"' + tempTime + '"' ;
		  var upTxt = 'INSERT INTO LOGS (id , latitude, longitude ,accuracy ,timestamp) VALUES (' + touchTime + ', ' + tmpTxt + ')';
		  alert(upTxt);
		  tx.executeSql(upTxt);
		  msg = '<p>Log message created and row inserted. ' + upTxt + '</p>';
		  document.querySelector('#status').innerHTML =  msg;
		});
	}  

	translateOptions = function (point){
		bm.clearOverlays();
		var marker = new BMap.Marker(point);
		bm.addOverlay(marker);
		bm.setCenter(point);
		document.getElementById("baiduXY").innerHTML = point.lng + "," + point.lat;

		newgps_x = point.lng;
		newgps_y = point.lat;
		//alert(point.lng + ',' + point.lat);
	}

function listenForPositionUpdates() {
  if (nav == null) {
      nav = window.navigator;
  }
  if (nav != null) {
      var geoloc = nav.geolocation;
      if (geoloc != null) {
          watchID = geoloc.watchPosition(handle_geolocation_query,errorCallback);
      }
      else {
          alert("geolocation not supported");
      }
  }
  else {
      alert("Navigator not found");
  }
}


	function clearn_log() {  
		var text = "";
		jQuery("#info").html(text);
		touchTime = 1 ;
		
	}  
	function save_log() {  
		var text = "";
		geolocationJson = jQuery("#info").html();
		jQuery("#info").html(text);
		

	}  
	function load_log() {  
		var text = "";
		jQuery("#info").html(text);
		jQuery("#info").html(geolocationJson);
		db.transaction(function (tx) {
		  tx.executeSql('SELECT * FROM LOGS', [], function (tx, results) {
		   var len = results.rows.length, i;
		   msg = "<p>Found rows: " + len + "</p>";
		   document.querySelector('#status').innerHTML +=  msg;
		   for (i = 0; i < len; i++){
			 msg = "<p><b>touchNo. :" + results.rows.item(i).id + "</b>, Time :" + results.rows.item(i).timestamp + "</p>";
			 document.querySelector('#status').innerHTML +=  msg;
		   }
		 }, null);
		});
	}  
 
</script>
<script type="text/javascript">

/*google map*/
      var map;

      function initialize() {
        var myOptions = {
          zoom: 17,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById('map_canvas'),
            myOptions);

        // Try HTML5 geolocation
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = new google.maps.LatLng(position.coords.latitude,
                                             position.coords.longitude);

            var infowindow = new google.maps.InfoWindow({
              map: map,
              position: pos,
              content: 'Location found using HTML5.'
            });

            map.setCenter(pos);
          }, function() {
            handleNoGeolocation(true);
          });
        } else {
          // Browser doesn't support Geolocation
          handleNoGeolocation(false);
        }
      }

      function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
          var content = 'Error: The Geolocation service failed.';
        } else {
          var content = 'Error: Your browser doesn\'t support geolocation.';
        }

        var options = {
          map: map,
          position: new google.maps.LatLng(60, 105),
          content: content
        };

        var infowindow = new google.maps.InfoWindow(options);
        map.setCenter(options.position);
      }

      google.maps.event.addDomListener(window, 'load', initialize);
      
      /*百度 马屁*/
      (function(){        //闭包
function load_script(xyUrl, callback){
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = xyUrl;
    //借鉴了jQuery的script跨域方法
    script.onload = script.onreadystatechange = function(){
        if((!this.readyState || this.readyState === "loaded" || this.readyState === "complete")){
            callback && callback();
            // Handle memory leak in IE
            script.onload = script.onreadystatechange = null;
            if ( head && script.parentNode ) {
                head.removeChild( script );
            }
        }
    };
    // Use insertBefore instead of appendChild  to circumvent an IE6 bug.
    head.insertBefore( script, head.firstChild );
}
function translate(point,type,callback){
    var callbackName = 'cbk_' + Math.round(Math.random() * 10000);    //随机函数名
    var xyUrl = "http://api.map.baidu.com/ag/coord/convert?from="+ type + "&to=4&x=" + point.lng + "&y=" + point.lat + "&callback=BMap.Convertor." + callbackName;
    //动态创建script标签
    load_script(xyUrl);
    BMap.Convertor[callbackName] = function(xyResult){
        delete BMap.Convertor[callbackName];    //调用完需要删除改函数
        var point = new BMap.Point(xyResult.x, xyResult.y);
		
        callback && callback(point);
    }
}

window.BMap = window.BMap || {};
BMap.Convertor = {};
BMap.Convertor.translate = translate;
})();
      
      
      
    </script>
</body>
</html>








